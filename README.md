# Приложение Wallet

## Описание
Это тестовое приложение для управления кошельком, разработанное с использованием Spring Boot. Приложение предоставляет REST API для выполнения операций с кошельком (пополнение и снятие средств) и получения баланса.

## Функциональность
- Создание нового кошелька
- Пополнение кошелька (DEPOSIT)
- Снятие средств с кошелька (WITHDRAW)
- Получение баланса кошелька по UUID

## API Endpoints
- `POST api/v1/wallets` - создание нового кошелька
  ```json
  // Ответ
  {
    "id": "UUID",
    "balance": 0.00
  }
  ```

- `POST api/v1/wallet` - выполнение операций с кошельком
  ```json
  // Запрос
  {
    "walletId": "UUID",
    "operationType": "DEPOSIT or WITHDRAW",
    "amount": 1000
  }
  
  // Ответ
  {
    "id": "UUID",
    "balance": 1000.00
  }
  ```

- `GET api/v1/wallets/{WALLET_UUID}` - получение баланса кошелька
  ```json
  // Ответ
  {
    "id": "UUID",
    "balance": 1000.00
  }
  ```

## Технологии
- Java 17
- Spring Boot 3.4.5
- PostgreSQL 15
- Liquibase (для миграций базы данных)
- Docker и Docker Compose
- Maven 3.9.9

## Особенности реализации
- Обработка конкурентных запросов (поддержка 1000 RPS на один кошелек)
- Механизм автоматических повторных попыток при конкурентных операциях
- Ограничение максимального количества одновременных операций (настраивается через параметр `MAX_CONCURRENT_OPERATIONS`, по умолчанию 1000)
- Корректная обработка ошибок (несуществующий кошелек, невалидный JSON, недостаточно средств)
- Миграции базы данных с помощью Liquibase
- Контейнеризация с Docker и Docker Compose
- Настраиваемые параметры приложения и базы данных без пересборки контейнеров
- Тестовое покрытие API endpoints

## Настраиваемые параметры
Приложение и база данных можно настраивать через переменные окружения без необходимости пересборки контейнеров:

### Параметры приложения
- `SERVER_PORT` - порт, на котором запускается приложение (по умолчанию: 8080)
- `INITIAL_BALANCE` - начальный баланс для новых кошельков (по умолчанию: 0)
- `MAX_CONCURRENT_OPERATIONS` - максимальное количество одновременных операций (по умолчанию: 1000)
- `MAX_RETRY_ATTEMPTS` - максимальное количество попыток при конкурентных операциях (по умолчанию: 3)
- `RETRY_DELAY_MS` - начальная задержка между попытками в миллисекундах (по умолчанию: 100)

### Параметры базы данных
- `DB_URL` - URL подключения к базе данных (по умолчанию: jdbc:postgresql://localhost:5432/wallet)
- `DB_USERNAME` - имя пользователя базы данных (по умолчанию: postgres)
- `DB_PASSWORD` - пароль базы данных (по умолчанию: postgres)
- `DB_PORT` - порт базы данных (по умолчанию: 5432)

## Механизм повторных попыток
Приложение использует механизм автоматических повторных попыток для обработки конкурентных операций:
- При возникновении конфликта операция автоматически повторяется
- Количество попыток настраивается через `MAX_RETRY_ATTEMPTS`
- Задержка между попытками увеличивается экспоненциально (начинается с `RETRY_DELAY_MS`)
- После исчерпания всех попыток возвращается ошибка с понятным сообщением

## Требования
- Docker и Docker Compose
- Maven 3.6 или выше (для локальной разработки)

## Установка и запуск

### Запуск с помощью Docker Compose
1. Клонируйте репозиторий:
   ```
   git clone https://github.com/thunderous-r/wallet.git
   ```

2. Перейдите в директорию проекта:
   ```
   cd wallet
   ```

3. Запустите приложение с помощью Docker Compose:
   ```
   docker-compose up -d
   ```

### Локальная разработка
1. Установите Java 17
2. Установите PostgreSQL 15
3. Соберите проект:
   ```
   mvn clean install
   ```
4. Запустите приложение:
   ```
   mvn spring-boot:run
   ```

## Конфигурация
Параметры приложения и базы данных можно настраивать через переменные окружения или файлы конфигурации без необходимости пересборки контейнеров. 